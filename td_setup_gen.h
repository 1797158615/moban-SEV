/*
 * File automatically generated by
 * gengen 1.4.2 by Lorenzo Bettini 
 * http://www.gnu.org/software/gengen
 */

#ifndef TD_SETUP_GEN_CLASS_H
#define TD_SETUP_GEN_CLASS_H

#include <string>
#include <iostream>

using std::string;
using std::ostream;

class td_setup_gen_class
{
 protected:
  string taname;

 public:
  td_setup_gen_class()
  {
  }
  
  td_setup_gen_class(const string &_taname) :
    taname (_taname)
  {
  }

  void set_taname(const string &_taname)
  {
    taname = _taname;
  }

  void generate_td_setup(ostream &stream, unsigned int indent = 0)
  {
    string indent_str (indent, ' ');
    indent = 0;
  
    stream << "#!/bin/bash";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "# 获取当前工作目录的绝对路径";
    stream << "\n";
    stream << indent_str;
    stream << "PWD_DIR=$(pwd)";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "# 判断传入的参数";
    stream << "\n";
    stream << indent_str;
    stream << "case \"$1\" in";
    stream << "\n";
    stream << indent_str;
    stream << "  # 默认执行所有操作";
    stream << "\n";
    stream << indent_str;
    stream << "  \"\")";
    stream << "\n";
    stream << indent_str;
    stream << "    gcc ta_server.c -o ta_server -lssh";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"编译 ta_server.c 失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    indent = 2;
    stream << "  ";
    indent = 0;
    stream << "\n";
    stream << indent_str;
    stream << "    # 编译 ta.c";
    stream << "\n";
    stream << indent_str;
    stream << "    gcc ";
    stream << taname;
    stream << ".c -o ";
    stream << taname;
    stream << " -lm";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"编译 ";
    stream << taname;
    stream << ".c 失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    # 克隆 tdx 仓库";
    stream << "\n";
    stream << indent_str;
    stream << "    git clone https://github.com/canonical/tdx.git";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"克隆 tdx 仓库失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    # 创建 tdx 镜像";
    stream << "\n";
    stream << indent_str;
    stream << "    cd \"$PWD_DIR/tdx/guest-tools/image\"";
    stream << "\n";
    stream << indent_str;
    stream << "    sudo ./create-td-image.sh -v 24.04";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"创建 tdx 镜像失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    # 使用 virt-customize 上传 ta 文件";
    stream << "\n";
    stream << indent_str;
    stream << "    sudo virt-customize -a \"$PWD_DIR/tdx/guest-tools/image/tdx-guest-ubuntu-24.04-generic.qcow2\" --upload \"$PWD_DIR/";
    stream << taname;
    stream << ":/home/tdx/\"";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"上传 ";
    stream << taname;
    stream << " 文件失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    # 运行 td.sh 脚本";
    stream << "\n";
    stream << indent_str;
    stream << "    cd \"$PWD_DIR/tdx/guest-tools\"";
    stream << "\n";
    stream << indent_str;
    stream << "    sudo ./run_td.sh";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"运行 td.sh 失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"所有操作成功完成\"";
    stream << "\n";
    stream << indent_str;
    stream << "    ;;";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "  # 执行上传 ta 文件";
    stream << "\n";
    stream << indent_str;
    stream << "  upload)";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ -z \"$2\" ] || [ -z \"$3\" ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"缺少参数，正确用法：./td_setup upload <文件名> <镜像内部路径>\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "    FILE_NAME=$2";
    stream << "\n";
    stream << indent_str;
    stream << "    INTERNAL_PATH=$3";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    sudo virt-customize -a \"$PWD_DIR/tdx/guest-tools/image/tdx-guest-ubuntu-24.04-generic.qcow2\" --upload \"$PWD_DIR/$FILE_NAME:$INTERNAL_PATH\"";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"上传 ta 文件失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"上传文件 $FILE_NAME 到 $INTERNAL_PATH 成功\"";
    stream << "\n";
    stream << indent_str;
    stream << "    ;;";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "  # 运行 td.sh 脚本";
    stream << "\n";
    stream << indent_str;
    stream << "  run)";
    stream << "\n";
    stream << indent_str;
    stream << "    cd \"$PWD_DIR/tdx/guest-tools\"";
    stream << "\n";
    stream << indent_str;
    stream << "    sudo ./run_td.sh";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"运行 td.sh 失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"td.sh 脚本执行成功\"";
    stream << "\n";
    stream << indent_str;
    stream << "    ;;";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "  # 创建 tdx 镜像并删除旧文件";
    stream << "\n";
    stream << indent_str;
    stream << "  image)";
    stream << "\n";
    stream << indent_str;
    stream << "    FILE1=\"$PWD_DIR/tdx/guest-tools/image/tdx-guest-ubuntu-24.04-generic.qcow2\"";
    stream << "\n";
    stream << indent_str;
    stream << "    FILE2=\"$PWD_DIR/tdx/guest-tools/image/ubuntu-24.04-server-cloudimg-amd64.img\"";
    stream << "\n";
    stream << indent_str;
    indent = 4;
    stream << "    ";
    indent = 0;
    stream << "\n";
    stream << indent_str;
    stream << "    if [ -f \"$FILE1\" ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      rm \"$FILE1\"";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"删除文件: $FILE1\"";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    if [ -f \"$FILE2\" ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      rm \"$FILE2\"";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"删除文件: $FILE2\"";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "    # 创建 tdx 镜像";
    stream << "\n";
    stream << indent_str;
    stream << "    cd \"$PWD_DIR/tdx/guest-tools/image\"";
    stream << "\n";
    stream << indent_str;
    stream << "    sudo ./create-td-image.sh -v 24.04";
    stream << "\n";
    stream << indent_str;
    stream << "    if [ $? -ne 0 ]; then";
    stream << "\n";
    stream << indent_str;
    stream << "      echo \"创建 tdx 镜像失败\"";
    stream << "\n";
    stream << indent_str;
    stream << "      exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    fi";
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"创建 tdx 镜像成功\"";
    stream << "\n";
    stream << indent_str;
    stream << "    ;;";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
    stream << "  # 其他未知的命令";
    stream << "\n";
    stream << indent_str;
    stream << "  *)";
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"未知命令: $1\"";
    stream << "\n";
    stream << indent_str;
    stream << "    echo \"可用命令: upload, run, image\"";
    stream << "\n";
    stream << indent_str;
    stream << "    exit 1";
    stream << "\n";
    stream << indent_str;
    stream << "    ;;";
    stream << "\n";
    stream << indent_str;
    stream << "esac";
    stream << "\n";
    stream << indent_str;
    stream << "\n";
    stream << indent_str;
  }
};

#endif // TD_SETUP_GEN_CLASS_H
